<!DOCTYPE html>
<html><head>
<meta charset="UTF-8">
<!--
Menu inspired by https://codepen.io/cassandraPaige/pen/ZEYmMJg

html symbols: https://www.toptal.com/designers/htmlarrows/symbols/

Tablo API Reference: https://jessedp.github.io/tablo-api-docs/#tablo-api-introduction
-->
<style>
html {
	font-family: Helvetica;
}
th {
	background: #04E;
	color: #fff;
	padding: 0.125rem 1rem 0.125rem 1rem;
}
table.byrow th {
	text-align: right;
}
td {
	padding: 0rem 1rem 0rem 1rem;
}

.container {
  min-height: 100vh;
}

nav a {
    font-size: 40px;
    color: #fff;
    text-decoration: none;
    padding: 20px;
    text-align: center;
}

nav {
    position: fixed;
    left: 0;
    z-index: 50;
    display: flex;
    justify-content: space-around;
    flex-direction: column;
    height: 100vh;
    background: #027;
}

section {
    position: absolute;
    top: 0;
    height: 100vh;
    width: 0;
    opacity: 0;
    display: flex;

} 

/* Styles applied on trigger */
section:target {
    opacity: 1;
    position: absolute;
    width: 100%;
    height: 100%;
    z-index: 10;
}

section:target div {
	padding-left: 100px; /* there has got to be a better way to keep the sidebar and section from overlapping. */
}

/* Change the width and height values if you want the video player to be a different size. */
video {
	height: 720px;
	width: 1280px;
}
</style>

<!--Load the hls video player to play .m3u8 playlists used by Tablo-->
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<!-- load my tablo api library -->
<script src="tablo_ota.js"></script>
<script>
if(Hls.isSupported()) {
	var hls = new Hls();
}

// Helper Functions

/* Get the value of a cookie */
function getCookie(name) {
  const value = `; ${document.cookie}`;
  const parts = value.split(`; ${name}=`);
  if (parts.length === 2) return parts.pop().split(';').shift();
}

/* save the tablo ip address to a cookie */
function save_tablo_ip() {
	var input = document.getElementById("tablo_ip_entry").value;
	var tv_listings_url = document.getElementById("tv_listings_url").value;
	document.cookie = `tablo_ip_addr=${input}; max-age=63115200; SameSite=Strict`;
	if (tv_listings_url) {
		document.cookie = `tv_listings_url=${tv_listings_url}; max-age=63115200; SameSite=Strict`;
	}
	bootstrap();
}

//User Interaction

/* Callback to load the Setup section. Just a placeholder. */
function doSetup() {

}

/* Callback to load the Home tab: device info, hd info, channel list */
async function doHome() {
  	//Inject the server info into the Home section
	tgetServerInfo().then(server => {
		document.getElementById("Tserver_name").innerHTML = `${server.name} (${server.local_address})`;
		document.getElementById("Tserver_version").innerHTML = server.version;
		document.getElementById("Tserver_model").innerHTML = server.model.name;
	});

  	//Inject the Harddrive data into the Home section
	tgetHarddrive().then(hd => {
		document.getElementById("Thd_info").innerHTML = '';
		for (drive of hd) {
			//NOTE: this will MESS UP if there is more than one HDD (like on the newer models that have an internal HD)
			document.getElementById("Thd_info").innerHTML += `<th>${drive.name}</th><td>${drive.free_mib} MB available of ${drive.size_mib} MB</td>`;
		}
	});

	//Get list of channels and nject the channel detail into the Home section
	tgetChannelList().then(channels => {
		document.getElementById("tchannel_count").innerHTML = Object.keys(channels).length;
		document.getElementById("tchannels").innerHTML = "<tr><th>Channel</th><th>Name</th><th>Quality</th></tr>";

		for (uri of channels) {
			//Inject details for each channel
			tgetDetails(uri).then(channel => {
				document.getElementById("tchannels").innerHTML += `<tr id="${channel.object_id}"><td><a href="#watch" onclick="doWatch('${channel.path}');">${channel.channel.major}.${channel.channel.minor}</a></td><td>` + 
				`${channel.channel.call_sign}</td><td>` + 
				`${channel.channel.resolution}</td></tr>`;
			});
		}
	});
}

/* Callback to load the Schedule tab: show currently scheduled recordings */
async function doSchedule() {
	//inject the list of scheduled recordings
	tgetScheduledRecordings().then(recordings => {	
		document.getElementById('tschedule_list').innerHTML =
		'<tr><th>ID</th><th>Name</th><th>Channel</th><th>Start</th><th>Duration</th><th>Delete?</th></tr>';
		document.getElementById("tschedule_count").innerHTML = Object.keys(recordings).length;

		for (path of recordings) {
			//Inject details of each recording
			tgetDetails(path).then(recording => {
				document.getElementById('tschedule_list').innerHTML +=	`<tr><td>${recording.object_id}</td><td>${recording.airing_details.show_title}</td><td>${recording.airing_details.channel.channel.call_sign}</td><td>${recording.airing_details.datetime}</td><td>${recording.airing_details.duration}</td><td>-</td></tr>`;
			});
		}
	});
}
	
//* Callback to load the Recordings section and list all airings */
async function doRecordings() {
	const base_url = "http://" + document.getElementById("tablo_ip_entry").value + ":8885";

	//Inject list of completed recordings
	tgetRecordings().then(recordings => {
		document.getElementById('Trecordings').innerHTML = "<tr><th>ID</th><th>Name</th><th>Duration</th><th>Is Clean</th><th>Resolution</th><th>Channel</th><th>Data</th></tr>\n";
		document.getElementById("trec_count").innerHTML = Object.keys(recordings).length;
	
		for (path of recordings) {
			tgetDetails(path).then(recording => {
				document.getElementById('Trecordings').innerHTML += `<tr><td>${recording.object_id}</td><td>` +
					`<a href="#watch" onClick="doWatch('${recording.path}');">${recording.airing_details.show_title}</a></td><td>` + 
					Math.round(recording.video_details.duration/60) + "m </td><td>" +
					`${recording.video_details.clean}</td><td>` +
					`${recording.video_details.height}</td><td>` +
					`${recording.airing_details.channel.channel.call_sign}</td><td>` + 
					`${recording.airing_details.datetime}</td></tr>\n`;
			});
		}
	});
}

/* Callback to load the Watch section and start the selected video stream */
async function doWatch(path) {
	tgetWatchDetails(path).then(stream => {
		document.getElementById('playlist_url').innerHTML = `The playlist URL is "${stream.playlist_url}".`;

		/* EXPERIMENTAL use HLS to play video directly from Tablo */
		var video = document.getElementById('video');
		if(Hls.isSupported()) {
			//var hls = new Hls();
			hls.attachMedia(video);
			hls.loadSource(stream.playlist_url);
			video.play();
		} else if (video.canPlayType('application/vnd.apple.mpegurl')) {
			video.src = stream.playlist_url;
			video.addEventListener('loadedmetadata',function() {
				video.play();
			});
		} else {
			alert("Unable to play the video. Note: the hls.js open source javascript player is needed for this to work.");
		}
	});
}

// callback for the stop button below the video
function StopVideo() {
	var video = document.getElementById('video');
	hls.attachMedia(video);
	hls.stopLoad();
}
/* Callback to load the Settings section. Not yet implemented. */
function doSettings() {
	document.getElementById("device_settings").innerHTML = '';
	tgetSettings().then(setting => {
		tgetDetails(setting.recording_quality).then(quality => {
			document.getElementById("device_settings").innerHTML += `<tr><th>Recording Quality</th><td>${quality.name}</td></th>`;
		})
		tgetDetails(setting.livetv_quality).then(quality => {
			document.getElementById("device_settings").innerHTML += `<tr><th>Live TV Quality</th><td>${quality.name}</td></th>`;
		})
		document.getElementById("device_settings").innerHTML += `<tr><th>LED status</th><td>${setting.led}</td></tr>\n` +
			`<tr><th>extend live recordings</th><td>${setting.extend_live_recordings}</td></tr>\n` +
			`<tr><th>auto delete recordings</th><td>${setting.auto_delete_recordings}</td></tr>\n` +
			`<tr><th>exclude duplicates</th><td>${setting.exclude_duplicates}</td></tr>\n` +
			`<tr><th>fast live startup</th><td>${setting.fast_live_startup}</td></tr>\n` +
			`<tr><th>Audio Format</th><td>${setting.audio}</td></tr>\n` +
			`<tr><th>data collection</th><td>${setting.data_collection}</td></tr>\n` +
			`<tr><th>preferred audio track</th><td>${setting.preferred_audio_track}</td></tr>\n`;
	});
}

//BOOSTRAP
function bootstrap() {
	let tablo_ip_addr = getCookie('tablo_ip_addr');
	const tv_listings_url = getCookie('tv_listings_url');
	if (tv_listings_url) {
		document.getElementById("tv_listings_link").href = tv_listings_url;
	}
	
	if (tablo_ip_addr) {
		document.getElementById("tablo_ip_entry").value = tablo_ip_addr;
		doHome();
		location.href = location.href.replace(/#.*$/,'') + "#home";
	} else {
		location.href = location.href.replace(/#.*$/,'') + "#setup";
	}
}

</script>

</head><body onload="bootstrap();">
<nav>
<!--<a href="#setup">&#10070;</a><!--Setup-->
<a href="#home" onclick="doHome()">&#8962;</a><!--Home-->
<a href="#recordings" onclick="doRecordings()">&#9991;</a><!--Recordings-->
<a href="#schedule" onclick="doSchedule()">&#9998;</a><!--Schedule-->
<a href="#settings" onclick="doSettings()">&#9881;</a><!--Settings-->
<a href="#about">?</a><!--About-->
<!--<a href="#watch">W</a><!--Watch-->
</nav>

<div class="container">
<section id="setup"><!-- ################################################# -->
<div>
<h1>Setup</h1>
<form>
<table>
	<tr><th>Tablo IP Address:</th><td><input id="tablo_ip_entry" type="text" required pattern="((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)(\.|$)){4}" title="Enter a valid IPv4 Address"/> <i>i.e. 10.10.10.2</i></td></tr>
	<tr><th>Listings Provider URL:</th><td><input id="tv_listings_url" type="text" pattern="(https:\/\/|http:\/\/)?[a-zA-Z0-9]{2,}(\.[a-zA-Z0-9]{2,})(\.[a-zA-Z0-9]{2,})?\/([a-zA-Z0-9\.\/\-]*)" title="Leave blank or provide a valid URL"/> <i>will be displayed beside the channel listing</i></td></tr>
</table>
<input type="submit" value="Save" onclick="save_tablo_ip();">
</form>
<br>
<p>These values will be saved in cookies in your web browser. If you remove the cookies, you will need to re-enter.</p>
</div>
</section>

<section id="home"><!-- ################################################# -->
<div>
<h1>Home</h1>
<table class="byrow">
	<tr><th>Tablo Name:</th><td id="Tserver_name"><td></tr>
	<tr><th>Tablo Model:</th><td id="Tserver_model"><td></tr>
	<tr><th>Tablo Firmware:</th><td id="Tserver_version"><td></tr>
	<tr id="Thd_info"></tr>
</table>

<h2>Active Channels (<span id="tchannel_count"></span>)</h2>
<p><a id="tv_listings_link" href="https://www.ontvtonight.com/ca/guide/listings/TorontoNight.html" target="_blank">Tonight's OTA TV Listings</a></p>
<table id="tchannels"></table>
</div>
</section>

<section id="recordings"><!-- ################################################# -->
<div>
<h1>Recordings (<span id="trec_count"></span>)</h1>
<table id="Trecordings"></table>
</div>
</section>

<section id="schedule"><!-- ################################################# -->
<div>
<h1>Schedule</h1>

<h2>Schedule a New Recording</h2>

<p>Not yet implemented.</p>

<h2>Scheduled Recordings (<span id="tschedule_count"></span>)</h2>

<table id="tschedule_list">
	<tr><th>ID</th><th>Name</th><th>Channel</th><th>Start</th><th>Duration</th><th>Delete?</th></tr>
</table>

</div>
</section>

<section id="settings"><!-- ################################################# -->
<div>
<h1>Settings</h1>

<table class="byrow" id="device_settings"></table>
</div>
</section>

<section id="watch"><!-- ################################################# -->
<div>
<h1>Watch</h1>
<p><center><span id="playlist_url">Loading ...</span></center></p>

<video id="video" controls></video><br/>
<p><button onClick="StopVideo();">Stop</button> Press the button when you are done!</p>
</div>
</section>

<section id="about"><!-- ################################################# -->
<div>
<h1>About</h1>
<p>Tablo Lite is a single page application (SPA) to provide a basic user interface to the <a href="https://www.tablotv.com/">Tablo</a> network attached OTA PVR made by Nuvyyo. It was built as a backup to work with the older 2-Tuner device in the event that the official web application becomes unavailable or no longer supports the device.<p>

<h2>References</h2>
<ul>
 <li>Official <a href="https://community.tablotv.com/c/tablo-apps/third-party-apps-plex/17">3rd Party Apps</a> in the Tablo Community Forums.</li>
 <li>Official <a href="https://www.tablotv.com/">Tablo</a> website.</li>
 <li>Official <a href="http://my.tablotv.com/">TabloTV</a> Web UI.</li>
 <li><a href="https://jessedp.github.io/tablo-api-docs/#tablo-api-introduction">Tablo API - unofficial</a></li>
 <li><a href="https://github.com/video-dev/hls.js/"> hls.js</a> video player to support m3u8 playlists.</li>
</ul>
 
<h2>Saving Recordings</h2>
<p>Tablo Lite does not support saving recordings from the device but you can use ffmpeg to exact a recording and save it to a file.</p>

<code>ffmpeg -i "stream_url" -c copy -bsf:a aac_adtstoasc "filename.mp4"</code>

<ul>
	<li><i>stream_url</i> is the url of the stream that is displayed at the top when playing a recording.</li>
	<li><i>filename</i> is the name of the file to save the recording.</li>
</ul>
</div>
</section>
</div></body></html>